<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM ì˜ë¥˜ ì¶”ì²œ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .container {
            min-height: 90vh;
            padding: 0 10%;
            display: flex;
            flex-direction: column;
        }

        .footer {
            width: 100%;
            text-align: center;
            padding: 20px;
            background-color: #f8f8f8;
            color: #666;
            font-size: 14px;
            margin-top: 30px;
            border-top: 1px solid #ddd;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem 0 0;
        }

        .logo-image {
            width: 60px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notice {
            font-size: 1rem;
        }

        .auth-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: normal;
            cursor: pointer;
        }

        .btn-ghost {
            background: transparent;
        }

        .btn-ghost:hover {
            background: transparent;
        }

        .btn-black {
            background-color: #ff4a48;
            color: white;
            padding: 0.5rem 1rem;
        }

        .btn-outline {
            border: 1px solid #E5E7EB;
            background: transparent;
            height: 48px;
            flex: 1;
        }

        .btn-outline:hover {
            border-color: #D1D5DB;
        }

        a {
            text-decoration-line: none;
            color: black;
        }

        main {
            flex-grow: 1;
            display: flex;
            margin-top: 2rem;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .title {
            font-size: 32px;
            font-weight: normal;
            color: #1a1a1a;
            font-size: 42px;
            font-weight: 700;
        }
        .sub-title {
            margin-bottom: 3rem;
            font-weight: 500;
        }

        .example-prompts {
            width: 100%;
            max-width: 850px;
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-form {
            width: 100%;
            max-width: 850px;
        }

        .input-group {
            display: flex;
            gap: 1rem;
        }

        .input-text {
            flex-grow: 1;
            height: 48px;
            padding: 0.5rem 1rem;
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .recommendation {
            width: 100%;
            max-width: 850px;
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #E5E7EB;
            border-radius: 0.5rem;
        }

        .ad-section {
            width: 200px;
            height: 400px;
            position: relative;
            overflow: hidden;
        }

        .ad-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            transition: opacity 1s ease-in-out, transform 1s ease-in-out;
        }

        .fade-out {
            opacity: 0;
            transform: rotate(360deg) scale(0.5);
        }

        .fade-in {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        .recommendation-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background: white;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }

        .recommendation-item:hover {
            transform: translateY(-5px);
        }

        /* ì „ì²´ í™”ë©´ ë®ëŠ” ë°˜íˆ¬ëª… ë ˆì´ì–´ */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª… ê²€ì€ìƒ‰ */
            backdrop-filter: blur(5px); /* ë¸”ëŸ¬ íš¨ê³¼ */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ */
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo">
            <a href="/"><img class="logo-image" src="/img/kp.png"></a>
        </div>
        <div class="header-right">
            <div class="auth-buttons">
                <a href="/notice"><button class="btn btn-ghost">Notice</button></a>
                <a href="/login"><button class="btn btn-ghost">Sign In</button></a>
                <a href="/register"><button class="btn btn-black">Sign Up</button></a>
                <a href="/logout" style="display: none"><button class="btn btn-black">Log Out</button></a>
            </div>
        </div>
    </header>
    <main>
        <div class="content">
            <h1 class="title">ë‚˜ë§Œì˜ ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸</h1>
            <h3 class="sub-title">íŒ¨ì…˜ ì¶”ì²œ ì‹œìŠ¤í…œ</h3>
            <form class="input-form" id="promptForm">
                <div class="input-group">
                    <input type="text" class="input-text" id="promptInput" placeholder="ì˜ë¥˜ ì¶”ì²œì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                    <input type="hidden" id="gender" value="female">
                    <button type="submit" class="btn btn-black" style="width: 112px;">ì¶”ì²œë°›ê¸°</button>
                </div>
            </form>
            <div class="example-prompts" id="examplePrompts">
                <!-- JavaScript will populate this -->
            </div>
            <div class="recommendation" id="recommendation" style="display: none;">
                <!-- JavaScript will populate this -->
            </div>
        </div>
        <div class="ad-section">
            <a id="ad-link" href="https://spao.com/product/project.html?cate_no=5759" target="_blank">
                <img id="ad-img" class="ad-image fade-in" src="https://spao.com/web/upload/category/shop1_5759_top_873043.png" alt="ê´‘ê³  ì´ë¯¸ì§€">
            </a>
        </div>
<!--        <div>-->
<!--            <p>í† í°: <span th:text="${jws}"></span></p>-->
<!--        </div>-->
    </main>
</div>

<footer class="footer">
    <p>&copy; 2025 <strong>Korean Prometheus</strong>. All rights reserved.</p>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ localStorageì— ì €ì¥ ì˜ˆì‹œ -->
    window.localStorage.setItem('jwt', `[[${jws}]]`);
    // í–¥í›„ ajax/fetch ìš”ì²­ ì‹œ localStorage.getItem('jwt')ë¡œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ

    const logoutBtn = document.querySelector('a[href="/logout"]');  // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
    const loginBtn = document.querySelector('a[href="/login"]');    // ë¡œê·¸ì¸ ë²„íŠ¼
    const registerBtn = document.querySelector('a[href="/register"]'); // íšŒì›ê°€ì… ë²„íŠ¼

    const token = localStorage.getItem("jwt"); // JWT í† í° ê°€ì ¸ì˜¤ê¸°

    if (token) {
        // âœ… ë¡œê·¸ì¸ ìƒíƒœ (JWTê°€ ì¡´ì¬í•¨)
        logoutBtn.style.display = "inline-block"; // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ
        loginBtn.style.display = "none"; // ë¡œê·¸ì¸ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        registerBtn.style.display = "none"; // íšŒì›ê°€ì… ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    } else {
        // âŒ ë¹„ë¡œê·¸ì¸ ìƒíƒœ (JWT ì—†ìŒ)
        logoutBtn.style.display = "none"; // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        loginBtn.style.display = "inline-block"; // ë¡œê·¸ì¸ ë²„íŠ¼ í‘œì‹œ
        registerBtn.style.display = "inline-block"; // íšŒì›ê°€ì… ë²„íŠ¼ í‘œì‹œ
    }

    const ads = [
        { img: "https://spao.com/web/upload/category/shop1_5759_top_873043.png", url: "https://spao.com/product/project.html?cate_no=5759" },
        { img: "https://spao.com/web/upload/appfiles/ZaReJam3QiELznoZeGGkMG/5b05408434690cb90e2ec67bb3f458d3.png", url: "https://spao.com/product/project.html?cate_no=4827" },
        { img: "https://spao.com/web/upload/category/shop1_4182_top_214888.jpg", url: "https://spao.com/" },
    ];

    let currentIndex = 0;
    const adImg = document.getElementById("ad-img");
    const adLink = document.getElementById("ad-link");

    function changeAd() {
        adImg.classList.remove("fade-in");
        adImg.classList.add("fade-out");

        setTimeout(() => {
            currentIndex = (currentIndex + 1) % ads.length;
            adImg.src = ads[currentIndex].img;
            adLink.href = ads[currentIndex].url;

            adImg.classList.remove("fade-out");
            adImg.classList.add("fade-in");
        }, 1000);
    }

    setInterval(changeAd, 5000); // 3ì´ˆë§ˆë‹¤ ê´‘ê³  ë³€ê²½

    const examplePrompts = [
        "ê²°í˜¼ì‹ì— ì…ê³  ê°ˆ ì˜·",
        "ì—¬ë¦„ í•´ë³€ ì—¬í–‰ìš© ì˜·",
        "íšŒì‚¬ ë©´ì ‘ìš© ì •ì¥ ì¶”ì²œ"
    ];

    // Populate example prompts
    const promptsContainer = document.getElementById('examplePrompts');
    examplePrompts.forEach(prompt => {
        const button = document.createElement('button');
        button.className = 'btn btn-outline';
        button.textContent = prompt;
        button.onclick = () => {
            document.getElementById('promptInput').value = prompt;
        };
        promptsContainer.appendChild(button);
    });

    // ì¿ í‚¤ì—ì„œ íŠ¹ì • ê°’ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getCookie(name) {
        const cookies = document.cookie.split("; ");
        for (let cookie of cookies) {
            const [key, value] = cookie.split("=");
            if (key === name) return value;
        }
        return null;
    }

    // Handle form submission
    document.getElementById('promptForm').onsubmit = async (e) => {
        e.preventDefault();

        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            window.location.href = "/login"; // ğŸš€ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            return;
        }

        // const session = getCookie("jwt"); // 'session' ì¿ í‚¤ ê°’ ê°€ì ¸ì˜¤ê¸°
        //
        // if (!session) {
        //     alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
        //     window.location.href = "/login"; // ğŸš€ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        //     return;
        // }

        const form = document.getElementById('promptForm');
        const promptInputValue = document.getElementById('promptInput').value.trim();
        const recommendButton = document.querySelector(".btn-black");
        const loadingOverlay = document.getElementById("loading-overlay"); // ë¡œë”© ë ˆì´ì–´

        if (!promptInputValue) {
            alert("í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        // ğŸ”’ ë²„íŠ¼ ë¹„í™œì„±í™”
        recommendButton.disabled = true;
        recommendButton.textContent = "ì¶”ì²œ ì¤‘..."; // ë¡œë”© ìƒíƒœ í‘œì‹œ
        loadingOverlay.style.display = "flex"; // ë¡œë”© ë ˆì´ì–´ í™œì„±í™”

        const formData = new FormData(form);
        formData.append("gender", document.getElementById("gender").value);
        formData.append("promptInput", promptInputValue);

        const jsonObject = Object.fromEntries(formData.entries());
        const recommendationDiv = document.getElementById('recommendation');

        try {
            console.log("ì „ì†¡ ì‹œì‘")
            const response = await fetch('http://127.0.0.1:8000/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonObject)
            });

            if (!response.ok) {
                throw new Error("ì„œë²„ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }

            const data = await response.json();
            console.log('Raw Response:', data);

            // âœ… JSON ë°ì´í„° íŒŒì‹±
            let responseData;
            try {
                responseData = typeof data.response === "string" ? JSON.parse(data.response) : data.response;
                console.log("Parsed Response Data:", responseData);
            } catch (error) {
                console.error("JSON Parsing Error:", error);
                recommendationDiv.textContent = "JSON ë°ì´í„° ë³€í™˜ ì˜¤ë¥˜";
                return;
            }

            // âœ… `recommendations` í‚¤ê°€ ì•„ë‹ˆë¼ `top`ê³¼ `bottom`ì„ ì§ì ‘ í™•ì¸í•´ì•¼ í•¨
            const { top, bottom } = responseData;

            if (!top && !bottom) {
                throw new Error("ì¶”ì²œ ê²°ê³¼ ì—†ìŒ");
            }

            // ğŸ›  ê¸°ì¡´ ì¶”ì²œ ê²°ê³¼ ì´ˆê¸°í™”
            recommendationDiv.innerHTML = "";

            // ğŸ›  `top` ì•„ì´í…œì´ ìˆëŠ” ê²½ìš° ì¶”ê°€
            if (top) {
                const topItemHTML = `
        <a href="${top.url}" target="_blank" class="view-product">
            <div class="recommendation-item">
                <img src="${top.image}" alt="${top.title}" class="product-image">
                <div class="product-info">
                    <h3>${top.title} (ìƒì˜)</h3>
                    <p><strong>ê°€ê²©:</strong> ${top.price.toLocaleString()}ì›</p>
                    <br>
                    <p><strong>ìƒ‰ìƒ:</strong> ${top.color}</p>
                    <p><strong>ì‚¬ì´ì¦ˆ:</strong> ${top.size}</p>
                    <p><strong>ì†Œì¬:</strong> ${top.material}</p>
                    <br>
                    <p class="recommendation-reason"><strong>ì¶”ì²œ ì´ìœ :</strong> ${top.reason}</p>
                </div>
            </div>
        </a>
        `;
                recommendationDiv.innerHTML += topItemHTML;
            }

            // ğŸ›  `bottom` ì•„ì´í…œì´ ìˆëŠ” ê²½ìš° ì¶”ê°€
            if (bottom) {
                const bottomItemHTML = `
        <a href="${bottom.url}" target="_blank" class="view-product">
            <div class="recommendation-item">
                <img src="${bottom.image}" alt="${bottom.title}" class="product-image">
                <div class="product-info">
                    <h3>${bottom.title} (í•˜ì˜)</h3>
                    <p><strong>ê°€ê²©:</strong> ${bottom.price.toLocaleString()}ì›</p>
                    <br>
                    <p><strong>ìƒ‰ìƒ:</strong> ${bottom.color}</p>
                    <p><strong>ì‚¬ì´ì¦ˆ:</strong> ${bottom.size}</p>
                    <p><strong>ì†Œì¬:</strong> ${bottom.material}</p>
                    <br>
                    <p class="recommendation-reason"><strong>ì¶”ì²œ ì´ìœ :</strong> ${bottom.reason}</p>
                </div>
            </div>
        </a>
        `;
                recommendationDiv.innerHTML += bottomItemHTML;
            }

            // ğŸ›  ì¶”ì²œ ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
            recommendationDiv.style.display = 'block';
            console.log("ì „ì†¡ ë")

        } catch (error) {
            console.error('Error:', error);
            recommendationDiv.innerHTML = '<p>ì¶”ì²œ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            recommendationDiv.style.display = 'block';
        } finally {
            // âœ… ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            recommendButton.disabled = false;
            recommendButton.textContent = "ì¶”ì²œë°›ê¸°";
            loadingOverlay.style.display = "none"; // ë¡œë”© ë ˆì´ì–´ ìˆ¨ê¸°ê¸°
        }

    };

</script>
<div id="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
</div>
</body>
</html>