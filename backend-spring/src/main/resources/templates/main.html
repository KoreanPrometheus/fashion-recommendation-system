<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM 의류 추천 시스템</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .container {
      min-height: 100vh;
      padding: 0 10%;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 2rem 0 0;
      gap: 500px;
    }

    footer {
      width: 100%;
      text-align: center;
      padding: 20px;
      background-color: #f8f8f8;
      color: #666;
      font-size: 14px;
      margin-top: 30px;
      border-top: 1px solid #ddd;
    }

    .logo-image {
      width: 60px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .notice {
      font-size: 1rem;
    }

    .auth-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: normal;
      cursor: pointer;
    }

    .btn-ghost {
      background: transparent;
    }

    .btn-ghost:hover {
      background: transparent;
    }

    .btn-black {
      background-color: #ff4a48;
      color: white;
      padding: 0.5rem 1rem;
    }

    .btn-black:hover {
      background-color: #f5ae79;
    }

    .btn-outline {
      border: 1px solid #E5E7EB;
      background: transparent;
      height: 48px;
      flex: 1;
    }

    .btn-outline:hover {
      border-color: #D1D5DB;
    }

    main {
      flex-grow: 1;
      display: flex;
      margin-top: 2rem;
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .title {
      font-size: 32px;
      font-weight: normal;
      color: #1a1a1a;
      font-size: 42px;
      font-weight: 700;
    }
    .sub-title {
      margin-bottom: 3rem;
      font-weight: 500;
    }

    .example-prompts {
      width: 100%;
      max-width: 768px;
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .input-form {
      width: 100%;
      max-width: 768px;
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
    }

    .input-text {
      flex-grow: 1;
      height: 48px;
      padding: 0.5rem 1rem;
      border: 1px solid #E5E7EB;
      border-radius: 0.5rem;
      font-size: 1rem;
    }

    .recommendation {
      width: 100%;
      max-width: 768px;
      margin-top: 1.5rem;
      padding: 1rem;
      background-color: #E5E7EB;
      border-radius: 0.5rem;
    }

    .recommendation-item {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      background: white;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease-in-out;
    }

    .recommendation-item:hover {
      transform: translateY(-5px);
    }

    .product-image {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
    }

    .product-info {
      flex: 1;
    }

    .product-info h3 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }

    .product-info p {
      margin: 5px 0;
      font-size: 14px;
      color: #666;
    }

    .recommendation-reason {
      font-style: italic;
      color: #444;
    }

    .view-product {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 15px;
      background-color: black;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .view-product:hover {
      background-color: #333;
    }

    .ad-section {
      width: 200px;
      height: 400px;
      position: relative;
      overflow: hidden;
    }

    .ad-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      transition: opacity 1s ease-in-out, transform 1s ease-in-out;
    }

    .fade-out {
      opacity: 0;
      transform: rotate(360deg) scale(0.5);
    }

    .fade-in {
      opacity: 1;
      transform: rotate(0deg) scale(1);
    }

    /* 전체 화면 덮는 반투명 레이어 */
    #loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5); /* 반투명 검은색 */
      backdrop-filter: blur(5px); /* 블러 효과 */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000; /* 다른 요소보다 위 */
    }

    /* 로딩 스피너 */
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top: 5px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* 스피너 애니메이션 */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<header>
  <div class="logo">
    <a href="/"><img class="logo-image" src="/img/kp.png"></a>
  </div>
  <div class="header-right">
    <div class="auth-buttons">
      <a href="/notice"><button class="btn btn-ghost">Notice</button></a>
      <a href="/login"><button class="btn btn-ghost">Sign In</button></a>
      <a href="/register"><button class="btn btn-black">Sign Up</button></a>
    </div>
  </div>
</header>
<div class="container">
  <main>
    <div class="content">
      <h1 class="title">나만의 스타일리스트</h1>
      <h3 class="sub-title">패션 추천 시스템</h3>
      <form class="input-form" id="promptForm">
        <div class="input-group">
          <input type="text" class="input-text" id="promptInput" placeholder="의류 추천을 위한 프롬프트를 입력하세요...">
          <input type="hidden" id="gender" value="female">
          <button type="submit" class="btn recommendation-button btn-black" style="width: 112px;">추천받기</button>
        </div>
      </form>
      <div class="example-prompts" id="examplePrompts">
        <!-- JavaScript will populate this -->
      </div>
      <div class="recommendation" id="recommendation" style="display: none;">
        <!-- JavaScript will populate this -->
      </div>
    </div>
    <div class="ad-section">
      <a id="ad-link" href="https://spao.com/" target="_blank">
        <img id="ad-img" class="ad-image fade-in" src="https://spao.com/web/upload/category/shop1_5759_top_873043.png" alt="광고 이미지">
      </a>
    </div>
  </main>
</div>
<footer class="footer">
  <p>&copy; 2025 LLM 의류 추천 시스템. All rights reserved.</p>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const ads = [
    { img: "https://spao.com/web/upload/category/shop1_5759_top_873043.png", url: "https://spao.com/" },
    { img: "https://spao.com/web/upload/free_design/20250110/20250122_luckybox_pc.jpg", url: "https://spao.com/" },
    { img: "/img/spao3.png", url: "https://spao.com/" },
  ];

  let currentIndex = 0;
  const adImg = document.getElementById("ad-img");
  const adLink = document.getElementById("ad-link");

  function changeAd() {
    adImg.classList.remove("fade-in");
    adImg.classList.add("fade-out");

    setTimeout(() => {
      currentIndex = (currentIndex + 1) % ads.length;
      adImg.src = ads[currentIndex].img;
      adLink.href = ads[currentIndex].url;

      adImg.classList.remove("fade-out");
      adImg.classList.add("fade-in");
    }, 1000);
  }

  setInterval(changeAd, 5000); // 3초마다 광고 변경

  const examplePrompts = [
    "결혼식에 입고 갈 옷을 추천해 줘",
    "여름 해변 여행용 옷을 추천해 줘",
    "회사 면접용 정장을 추천해 줘"
  ];

  // Populate example prompts
  const promptsContainer = document.getElementById('examplePrompts');
  examplePrompts.forEach(prompt => {
    const button = document.createElement('button');
    button.className = 'btn btn-outline';
    button.textContent = prompt;
    button.onclick = () => {
      document.getElementById('promptInput').value = prompt;
    };
    promptsContainer.appendChild(button);
  });

  // Handle form submission
  document.getElementById('promptForm').onsubmit = async (e) => {
    e.preventDefault();

    const form = document.getElementById('promptForm');
    const promptInputValue = document.getElementById('promptInput').value.trim();
    const recommendButton = document.querySelector(".recommendation-button");
    const loadingOverlay = document.getElementById("loading-overlay"); // 로딩 레이어

    if (!promptInputValue) {
      alert("프롬프트를 입력하세요.");
      return;
    }

    // 🔒 버튼 비활성화 & 로딩 레이어 표시
    recommendButton.disabled = true;
    recommendButton.textContent = "추천 중..."; // 로딩 상태 표
    loadingOverlay.style.display = "flex"; // 로딩 레이어 활성화

    const formData = new FormData(form);
    formData.append("gender", document.getElementById("gender").value);
    formData.append("promptInput", promptInputValue);

    const jsonObject = Object.fromEntries(formData.entries());
    const recommendationDiv = document.getElementById('recommendation');

    try {
      const response = await fetch('http://127.0.0.1:8000/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(jsonObject)
      });

      if (!response.ok) {
        throw new Error("서버 응답이 올바르지 않습니다.");
      }

      const data = await response.json();
      console.log('Raw Response:', data);

      // ✅ JSON 데이터 파싱
      let responseData;
      try {
        responseData = typeof data.response === "string" ? JSON.parse(data.response) : data.response;
        console.log("Parsed Response Data:", responseData);
      } catch (error) {
        console.error("JSON Parsing Error:", error);
        recommendationDiv.textContent = "JSON 데이터 변환 오류";
        return;
      }

      const recommendations = responseData.recommendation || responseData.recommendations;

      if (!recommendations || recommendations.length === 0) {
        throw new Error("추천 결과 없음");
      }

      // 🛠 기존 추천 결과 초기화
      recommendationDiv.innerHTML = "";

      // 🛠 추천 상품 리스트를 HTML로 변환하여 추가
      recommendations.forEach(item => {
        // language=HTML
        const itemHTML = `
                <a href="${item.url}" style="text-decoration:none;" target="_blank">
                  <div class="recommendation-item">
                    <img src="${item.image}" alt="${item.title}" class="product-image">
                    <div class="product-info">
                        <h3>${item.title}</h3>
                        <p><strong>가격:</strong> ${item.price.toLocaleString()}원</p>
                        <p><strong>색상:</strong> ${item.color}</p>
                        <p><strong>사이즈:</strong> ${item.size}</p>
                        <p><strong>소재:</strong> ${item.material}</p>
                        <p class="recommendation-reason"><strong>추천 이유:</strong> ${item.reason}</p>
                    </div>
                  </div>
                </a>`;
        recommendationDiv.innerHTML += itemHTML;
      });

      // 🛠 추천 결과를 화면에 표시
      recommendationDiv.style.display = 'block';

    } catch (error) {
      console.error('Error:', error);
      recommendationDiv.innerHTML = '<p>추천 결과를 불러올 수 없습니다.</p>';
      recommendationDiv.style.display = 'block';
    } finally {
      // ✅ 버튼 다시 활성화
      recommendButton.disabled = false;
      recommendButton.textContent = "추천받기";
      loadingOverlay.style.display = "none"; // 로딩 레이어 숨기기
    }
  };

</script>
<div id="loading-overlay" style="display: none;">
  <div class="loading-spinner"></div>
</div>
</body>
</html>